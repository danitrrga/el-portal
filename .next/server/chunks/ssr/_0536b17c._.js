module.exports=[70106,a=>{"use strict";var b=a.i(72131),c={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};a.s(["default",0,(a,d)=>{let e=(0,b.forwardRef)(({color:e="currentColor",size:f=24,strokeWidth:g=2,absoluteStrokeWidth:h,className:i="",children:j,...k},l)=>(0,b.createElement)("svg",{ref:l,...c,width:f,height:f,stroke:e,strokeWidth:h?24*Number(g)/Number(f):g,className:["lucide",`lucide-${a.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase().trim()}`,i].join(" "),...k},[...d.map(([a,c])=>(0,b.createElement)(a,c)),...Array.isArray(j)?j:[j]]));return e.displayName=`${a}`,e}],70106)},24129,11366,a=>{"use strict";var b,c,d,e,f,g=a.i(10849),h=((b={}).ACTIVE="active",b.ARCHIVED="archived",b),i=((c={})[c.LOW=1]="LOW",c[c.MEDIUM=2]="MEDIUM",c[c.HIGH=4]="HIGH",c),j=((d={}).TASK_PROJECT="task_project",d.CONSISTENCY_METRIC="consistency_metric",d),k=((e={}).ROUTINE="routine",e.VISION_5Y="vision_5y",e.LIFE_TODO="life_todo",e.MANTRA_BANK="mantra_bank",e.THEORY_NOTES="theory_notes",e),l=((f={}).ME="Me",f.HER="Her",f.PURPOSE="Purpose",f.SOCIAL="Social",f.MATERIAL="Material",f);a.s(["ArchiveType",()=>k,"EntityStatus",()=>h,"GoalType",()=>j,"HabitWeight",()=>i,"SlideCategory",()=>l],11366);let m=new class{async getUserId(){let{data:{session:a}}=await g.supabase.auth.getSession();if(!a?.user)throw Error("Not authenticated");return a.user.id}async getProfile(){let a=await this.getUserId(),{data:b,error:c}=await g.supabase.from("profiles").select("*").eq("id",a).single();return c?(console.error("Error fetching profile:",c),null):b}async getSystemSettings(){let a=await this.getProfile();return{days:a?.version_days_default||90,cycles:a?.cycles_per_version_default||6}}async updateProfile(a){let b=await this.getUserId(),{error:c}=await g.supabase.from("profiles").update(a).eq("id",b);if(c)throw c}async uploadAvatar(a){let b=await this.getUserId(),c=a.name.split(".").pop(),d=`${b}/avatar-${Date.now()}.${c}`,e=`${d}`,{error:f}=await g.supabase.storage.from("el-portal-assets").upload(e,a,{upsert:!0});if(f)throw f;let{data:h}=g.supabase.storage.from("el-portal-assets").getPublicUrl(e);return h.publicUrl}async updateSystemSettings(a,b){let c=await this.getUserId(),{error:d}=await g.supabase.from("profiles").update({version_days_default:a,cycles_per_version_default:b}).eq("id",c);if(d)throw d}calculateDailyScore(a,b){if(0===a.length)return 0;let c=0,d=0;return(a.forEach(a=>{c+=a.weight,b.some(b=>b.habit_id===a.id&&b.status)&&(d+=a.weight)}),0===c)?0:Math.round(d/c*100)}calculateAsymptoticScore(a){return a<=0?0:Math.min(100,Math.round(100*(1-Math.exp(-.061*a))))}calculateHabitStreaks(a,b){let c=Array.from(new Set(b.filter(b=>b.habit_id===a&&b.status).map(a=>a.date))).sort();if(0===c.length)return{currentStreak:0,maxStreak:0};let d=0,e=0,f=null;for(let a of c){let b=new Date(a).getTime();f?1===Math.round((b-f)/864e5)?e++:(d=Math.max(d,e),e=1):e=1,f=b}d=Math.max(d,e);let g=0,h=new Date,i=h.toISOString().split("T")[0],j=new Date(h);j.setDate(j.getDate()-1);let k=j.toISOString().split("T")[0],l=null;if(c.includes(i)?(g=1,l=new Date(h)):c.includes(k)&&(g=1,l=new Date(j)),l)for(;;){l.setDate(l.getDate()-1);let a=l.toISOString().split("T")[0];if(c.includes(a))g++;else break}return{currentStreak:g,maxStreak:d}}async getDashboardData(){let a=await this.getProfile();if(!a)throw Error("Profile not found");let b=null,c=null;if(a.current_version_id){let{data:c}=await g.supabase.from("versions").select("*").eq("id",a.current_version_id).single();b=c}if(a.current_cycle_id){let{data:b}=await g.supabase.from("cycles").select("*").eq("id",a.current_cycle_id).single();c=b}let d=[],e=[];if(c){let{data:a}=await g.supabase.from("habits").select("*").eq("cycle_id",c.id);d=a||[];let{data:b}=await g.supabase.from("goals").select("*").eq("cycle_id",c.id);e=b||[]}let f=[];if(d.length>0){let a=d.map(a=>a.id),{data:b}=await g.supabase.from("habit_logs").select("*").in("habit_id",a);f=b||[]}let h=new Date().toISOString().split("T")[0],i=f.filter(a=>a.date===h),j={};return d.forEach(a=>{j[a.id]=this.calculateHabitStreaks(a.id,f)}),{version:b,cycle:c,habits:d,todayLogs:i,habitStats:j,goals:e}}async toggleHabit(a,b){let c=await this.getUserId(),d=new Date().toISOString().split("T")[0];if(b){let{error:b}=await g.supabase.from("habit_logs").insert({habit_id:a,date:d,status:!0,user_id:c});if(b)throw b;let{data:e}=await g.supabase.from("habits").select("linked_goal_id").eq("id",a).single();if(e&&e.linked_goal_id){await g.supabase.rpc("increment_goal_streak",{goal_id:e.linked_goal_id});let{data:a}=await g.supabase.from("goals").select("current_streak").eq("id",e.linked_goal_id).single();a&&await g.supabase.from("goals").update({current_streak:(a.current_streak||0)+1}).eq("id",e.linked_goal_id)}}else{let{error:b}=await g.supabase.from("habit_logs").delete().eq("habit_id",a).eq("date",d);if(b)throw b;let{data:c}=await g.supabase.from("habits").select("linked_goal_id").eq("id",a).single();if(c&&c.linked_goal_id){let{data:a}=await g.supabase.from("goals").select("current_streak").eq("id",c.linked_goal_id).single();a&&await g.supabase.from("goals").update({current_streak:Math.max(0,(a.current_streak||0)-1)}).eq("id",c.linked_goal_id)}}}async getSlides(){let{data:a}=await g.supabase.from("slides").select("*").order("category");return a?Promise.all(a.map(async a=>{if(a.image_url&&!a.image_url.startsWith("http")){let{data:b}=await g.supabase.storage.from("el-portal-assets").createSignedUrl(a.image_url,3600);if(b)return{...a,image_url:b.signedUrl}}return a})):[]}async updateSlide(a,b){let c=await this.getUserId(),d=a.image_url;if(b){let e=b.name.split(".").pop(),f=`${c}/${a.category}.${e}`,h=`${f}`,{error:i}=await g.supabase.storage.from("el-portal-assets").upload(h,b,{upsert:!0});if(i)throw i;d=h}let{data:e}=await g.supabase.from("slides").select("id").eq("category",a.category).single();e?await g.supabase.from("slides").update({image_url:d,caption:a.caption}).eq("id",e.id):await g.supabase.from("slides").insert({user_id:c,category:a.category,image_url:d,caption:a.caption})}async getSlideImageUrl(a){if(!a)return"";if(a.startsWith("http"))return a;let{data:b}=await g.supabase.storage.from("el-portal-assets").createSignedUrl(a,3600);return b?.signedUrl||""}async getArchives(){let{data:a}=await g.supabase.from("archives").select("*");return(a||[]).map(a=>({...a,content:"object"==typeof a.content&&a.content?.markdown?a.content.markdown:a.content}))}async updateArchive(a){let b=await this.getUserId(),c={markdown:a.content},{data:d}=await g.supabase.from("archives").select("id").eq("id",a.id).maybeSingle();d?await g.supabase.from("archives").update({type:a.type,title:a.title,content:c}).eq("id",a.id):await g.supabase.from("archives").insert({id:a.id,user_id:b,type:a.type,title:a.title,content:c})}async getHistoryData(){let a=await this.getUserId(),b=new Date,c=new Date;c.setDate(b.getDate()-90);let d=c.toISOString().split("T")[0],{data:e}=await g.supabase.from("habit_logs").select("*").eq("user_id",a).gte("date",d),f=e||[],{data:h}=await g.supabase.from("habits").select("*").eq("user_id",a),i=h||[],{data:j}=await g.supabase.from("cycles").select("*").eq("user_id",a),k=j||[],l={};i.forEach(a=>{l[a.id]=this.calculateHabitStreaks(a.id,f)});let m=[];for(let a=0;a<=90;a++){let d=new Date(c);d.setDate(d.getDate()+a);let e=d.toISOString().split("T")[0];if(e>b.toISOString().split("T")[0])break;let g=k.find(a=>a.start_date<=e&&a.end_date>=e),h=g?i.filter(a=>a.cycle_id===g.id):[],j=f.filter(a=>a.date===e),l=0,n=[];h.length>0&&(l=this.calculateDailyScore(h,j),h.forEach(a=>{let b=j.some(b=>b.habit_id===a.id&&b.status);n.push({habit:a,done:b})})),m.push({date:e,score:l,details:n})}return{dailyScores:m.reverse(),cycles:k,habitStats:l}}async createVersion(a){let b=await this.getUserId(),c=await this.getProfile(),d=c?.version_days_default||90,e=new Date(a.startDate),f=new Date(e);f.setDate(e.getDate()+d);let{data:i,error:j}=await g.supabase.from("versions").insert({user_id:b,number:a.number,title:a.title,description:a.description,status:h.ACTIVE,start_date:a.startDate,end_date:f.toISOString().split("T")[0]}).select().single();if(j)throw j;return await g.supabase.from("profiles").update({current_version_id:i.id}).eq("id",b),i}async updateGoal(a){let{error:b}=await g.supabase.from("goals").update({title:a.title,description:a.description,type:a.type,subtasks:a.subtasks,current_streak:a.current_streak}).eq("id",a.id);if(b)throw b}async getMantras(){let a=await this.getUserId(),{data:b}=await g.supabase.from("cycles").select("mantras").eq("user_id",a),c=new Set;b?.forEach(a=>a.mantras?.forEach(a=>c.add(a)));let{data:d}=await g.supabase.from("archives").select("content").eq("user_id",a).eq("type",k.MANTRA_BANK);return d?.forEach(a=>{let b="object"==typeof a.content&&a.content.markdown?a.content.markdown:JSON.stringify(a.content);c.add(b)}),Array.from(c)}async addMantra(a){let b=await this.getUserId();await g.supabase.from("archives").insert({user_id:b,type:k.MANTRA_BANK,title:"Mantra",content:{markdown:a}})}async createCycle(a,b,c){let d=await this.getUserId(),e=await this.getProfile();if(!e?.current_version_id)throw Error("No active version");let{count:f}=await g.supabase.from("cycles").select("*",{count:"exact",head:!0}).eq("version_id",e.current_version_id),{data:i,error:j}=await g.supabase.from("cycles").insert({user_id:d,version_id:e.current_version_id,sprint_number:(f||0)+1,start_date:new Date().toISOString().split("T")[0],end_date:new Date(Date.now()+12096e5).toISOString().split("T")[0],status:h.ACTIVE,focus_priorities:a.focus_priorities,problems:a.problems,cch_list:a.cch_list,mantras:a.mantras,learning_focus:a.learning_focus}).select().single();if(j)throw j;for(let a of b){let{data:b,error:c}=await g.supabase.from("goals").insert({user_id:d,cycle_id:i.id,title:a.title,description:a.description,type:a.type,subtasks:a.subtasks?.map(a=>({name:a,done:!1}))}).select().single();if(c&&console.error("Error creating goal",c),a.habit&&b){let{data:c,error:e}=await g.supabase.from("habits").insert({user_id:d,cycle_id:i.id,name:a.habit.name,weight:a.habit.weight,category:a.habit.category,linked_goal_id:b.id}).select().single();c&&await g.supabase.from("goals").update({linked_habit_id:c.id}).eq("id",b.id)}}for(let a of c)await g.supabase.from("habits").insert({user_id:d,cycle_id:i.id,name:a.name,weight:a.weight,category:a.category});return await g.supabase.from("profiles").update({current_cycle_id:i.id}).eq("id",d),i}async getLabData(){let a=await this.getUserId(),b=await this.getProfile(),{data:c}=await g.supabase.from("versions").select("*").eq("user_id",a),d=c?.find(a=>a.id===b?.current_version_id)||null,{data:e}=await g.supabase.from("cycles").select("*").eq("user_id",a).order("sprint_number",{ascending:!1}),f=d?(e||[]).filter(a=>a.version_id===d.id):[],{data:h}=await g.supabase.from("goals").select("*").eq("user_id",a),{data:i}=await g.supabase.from("habits").select("*").eq("user_id",a);return{goals:h||[],version:d,cycles:f,habits:i||[],activeCycleId:b?.current_cycle_id||null}}async updateCycle(a){let{error:b}=await g.supabase.from("cycles").update({start_date:a.start_date,end_date:a.end_date,status:a.status,focus_priorities:a.focus_priorities,problems:a.problems,cch_list:a.cch_list,mantras:a.mantras,learning_focus:a.learning_focus}).eq("id",a.id);if(b)throw b}async deleteCycle(a){let b=await this.getUserId(),{error:c}=await g.supabase.from("cycles").delete().eq("id",a);if(c)throw c;let d=await this.getProfile();d?.current_cycle_id===a&&await g.supabase.from("profiles").update({current_cycle_id:null}).eq("id",b)}async setCycleActive(a){let b=await this.getUserId();await g.supabase.from("profiles").update({current_cycle_id:a}).eq("id",b)}async addGoal(a){let b=await this.getUserId(),{error:c}=await g.supabase.from("goals").insert({id:a.id,user_id:b,cycle_id:a.cycle_id,title:a.title,description:a.description,type:a.type,subtasks:a.subtasks?.map(a=>({...a,name:a.name,done:a.done})),linked_habit_id:a.linked_habit_id,current_streak:a.current_streak});if(c)throw c}async deleteGoal(a){let{error:b}=await g.supabase.from("goals").delete().eq("id",a);if(b)throw b}async getAllHabits(){let a=await this.getUserId(),{data:b}=await g.supabase.from("habits").select("*").eq("user_id",a);return b||[]}async addHabit(a){let b=await this.getUserId(),{error:c}=await g.supabase.from("habits").insert({id:a.id,user_id:b,cycle_id:a.cycle_id,name:a.name,weight:a.weight,category:a.category,linked_goal_id:a.linked_goal_id});if(c)throw c}async updateHabit(a){let{error:b}=await g.supabase.from("habits").update({name:a.name,weight:a.weight,category:a.category,linked_goal_id:a.linked_goal_id}).eq("id",a.id);if(b)throw b}async deleteHabit(a){let{error:b}=await g.supabase.from("habits").delete().eq("id",a);if(b)throw b}async getAllVersions(){let a=await this.getUserId(),{data:b}=await g.supabase.from("versions").select("*").eq("user_id",a).order("start_date",{ascending:!1});return b||[]}async updateVersion(a){let{error:b}=await g.supabase.from("versions").update({title:a.title,description:a.description,start_date:a.start_date,end_date:a.end_date,status:a.status}).eq("id",a.id);if(b)throw b}async deleteVersion(a){let{error:b}=await g.supabase.from("versions").delete().eq("id",a);if(b)throw b}async getAllCycles(){let a=await this.getUserId(),{data:b}=await g.supabase.from("cycles").select("*").eq("user_id",a).order("sprint_number",{ascending:!1});return b||[]}async getAllGoals(){let a=await this.getUserId(),{data:b}=await g.supabase.from("goals").select("*").eq("user_id",a);return b||[]}async signOut(){await g.supabase.auth.signOut()}};a.s(["supabaseService",0,m],24129)}];

//# sourceMappingURL=_0536b17c._.js.map